import streamlit as st
import google.generativeai as genai
import os # <-- os ë¼ì´ë¸ŒëŸ¬ë¦¬ ì¶”ê°€

# ==========================================
# 1. ì„¤ì • ì˜ì—­ (API í‚¤ë¥¼ í™˜ê²½ ë³€ìˆ˜ì—ì„œ ìžë™ ë¡œë“œ)
# ==========================================
# í™˜ê²½ ë³€ìˆ˜ì—ì„œ í‚¤ë¥¼ ì½ì–´ì˜µë‹ˆë‹¤. (ì½”ë“œì— ì§ì ‘ í‚¤ë¥¼ ë„£ì§€ ì•ŠìŒ)
GOOGEL_API_KEY = os.environ.get("GEMINI_API_KEY")

if not GOOGEL_API_KEY:
    st.error("ì˜¤ë¥˜: API í‚¤ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. Windows í™˜ê²½ ë³€ìˆ˜ì— 'GEMINI_API_KEY'ê°€ ì„¤ì •ë˜ì—ˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.")
    st.stop() # í‚¤ê°€ ì—†ìœ¼ë©´ ì‹¤í–‰ ì¤‘ì§€

# API í‚¤ ì„¤ì •
genai.configure(api_key=GOOGEL_API_KEY)

# ==========================================
# 2. AIì—ê²Œ í•™ìŠµì‹¤í‚¬ ì§€ì‹ (Knowledge Base)
# ==========================================
# ì¸ì§€í–‰ë™ì¹˜ë£Œ(CBT) í•µì‹¬ ë‚´ìš©ì„ í…ìŠ¤íŠ¸ë¡œ ì •ì˜í•©ë‹ˆë‹¤.
cbt_knowledge = """
[ë‹¹ì‹ ì˜ ì—­í• ]
ë‹¹ì‹ ì€ 'ë¶ˆì•ˆìž¥ì•  ì¸ì§€í–‰ë™ì¹˜ë£Œ(CBT) ë³´ì¡° ì±—ë´‡'ìž…ë‹ˆë‹¤. 
ì‚¬ìš©ìžì˜ ë§ì„ ê²½ì²­í•˜ê³ , ì•„ëž˜ì˜ [ì¹˜ë£Œ ê¸°ë²•]ì„ í™œìš©í•˜ì—¬ ìƒë‹´ì„ ì§„í–‰í•˜ì„¸ìš”.
ì˜ì‚¬ê°€ ì•„ë‹ˆë¯€ë¡œ ì•½ë¬¼ ì²˜ë°©ì´ë‚˜ í™•ì •ì  ì§„ë‹¨ì€ í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ìœ„ê¸‰ ìƒí™©(ìží•´/ìžì‚´ ìœ„í—˜) ê°ì§€ ì‹œ ì¦‰ì‹œ ì „ë¬¸ê°€ ë„ì›€ì„ ê¶Œí•˜ì„¸ìš”.

[ì¹˜ë£Œ ê¸°ë²• ê°€ì´ë“œ]
1. ì¸ì§€ ìž¬êµ¬ì„± (Cognitive Restructuring):
   - ì‚¬ìš©ìžì˜ ë¶ˆì•ˆí•œ ìƒê°(ìžë™ì  ì‚¬ê³ )ì´ ì‚¬ì‹¤ì¸ì§€ ì¦ê±°ë¥¼ ì°¾ê²Œ í•˜ì„¸ìš”.
   - ì˜ˆì‹œ ì§ˆë¬¸: "ê·¸ ì¼ì´ ì‹¤ì œë¡œ ì¼ì–´ë‚  í™•ë¥ ì€ ì–¼ë§ˆë‚˜ ë ê¹Œìš”?", "ê·¸ë ‡ê²Œ ìƒê°í•˜ê²Œ ëœ êµ¬ì²´ì ì¸ ì¦ê±°ê°€ ìžˆë‚˜ìš”?"
   - ëª©í‘œ: ìž¬ì•™í™”(Catastrophizing) ì‚¬ê³ ë¥¼ ë©ˆì¶”ê³  ê°ê´€ì  ì‚¬ì‹¤ì„ ë³´ê²Œ í•¨.

2. ì†Œí¬ë¼í…ŒìŠ¤ì‹ ë¬¸ë‹µë²•:
   - ì •ë‹µì„ ë°”ë¡œ ì£¼ì§€ ë§ê³ , ì§ˆë¬¸ì„ í†µí•´ ì‚¬ìš©ìžê°€ ìŠ¤ìŠ¤ë¡œ ê¹¨ë‹«ê²Œ í•˜ì„¸ìš”.
   - ì˜ˆì‹œ: "ë§Œì•½ ì¹œêµ¬ê°€ ê°™ì€ ìƒí™©ì´ë¼ë©´ ë­ë¼ê³  ë§í•´ì£¼ê³  ì‹¶ë‚˜ìš”?"

3. ê·¸ë¼ìš´ë”©(Grounding) ê¸°ë²• - ê³µí™©/ê³¼ë„í•œ ë¶ˆì•ˆ ì‹œ:
   - ì§€ê¸ˆ ë‹¹ìž¥ ì˜¤ê°ì— ì§‘ì¤‘í•˜ê²Œ ìœ ë„í•˜ì„¸ìš”.
   - 5-4-3-2-1 ê¸°ë²•: ë³´ì´ëŠ” ê²ƒ 5ê°œ, ëŠê»´ì§€ëŠ” ê°ê° 4ê°œ, ë“¤ë¦¬ëŠ” ê²ƒ 3ê°œ, ëƒ„ìƒˆ 2ê°œ, ë§› 1ê°œ.

4. ë³µì‹ í˜¸í¡ ìœ ë„:
   - 4ì´ˆê°„ ì½”ë¡œ ìˆ¨ì„ ë“¤ì´ë§ˆì‹œê³ , 7ì´ˆê°„ ë©ˆì¶”ê³ , 8ì´ˆê°„ ìž…ìœ¼ë¡œ ì²œì²œížˆ ë‚´ë±‰ë„ë¡ ì•ˆë‚´í•˜ì„¸ìš”.

[ëŒ€í™” íƒœë„]
- ê³µê°ì ì´ê³  ë”°ëœ»í•œ ë§íˆ¬ë¥¼ ì‚¬ìš©í•˜ì„¸ìš”. ('~í•´ìš”', '~í–ˆêµ°ìš”' ë“±)
- í•œ ë²ˆì— ë„ˆë¬´ ê¸´ ì„¤ëª…ì„ í•˜ì§€ ë§ê³ , ëŒ€í™”ë¥¼ ì£¼ê³ ë°›ìœ¼ë©° í•˜ë‚˜ì”© ì§„í–‰í•˜ì„¸ìš”.
"""

# ==========================================
# 3. ëª¨ë¸ ì„¤ì • (Gemini 1.5 Flash)
# ==========================================
# system_instructionì„ í†µí•´ íŽ˜ë¥´ì†Œë‚˜ì™€ ì§€ì‹ì„ ì£¼ìž…í•©ë‹ˆë‹¤.
model = genai.GenerativeModel(
    model_name='gemini-2.5-flash', 
    system_instruction=cbt_knowledge
)
# ==========================================
# 4. ì›¹ì‚¬ì´íŠ¸ í™”ë©´ êµ¬ì„± (Streamlit)
# ==========================================
st.set_page_config(page_title="AI ë§ˆìŒ ìƒë‹´ì†Œ", page_icon="ðŸŒ¿")

st.title("ðŸŒ¿ AI ë¶ˆì•ˆ ì¼€ì–´ ìƒë‹´ì†Œ")
st.markdown("""
ì´ ì±—ë´‡ì€ **ì¸ì§€í–‰ë™ì¹˜ë£Œ(CBT)** ê¸°ë²•ì„ í•™ìŠµí–ˆìŠµë‹ˆë‹¤.  
ë¶ˆì•ˆí•œ ë§ˆìŒì´ ë“¤ ë•Œ, ê°€ë³ê²Œ ì´ì•¼ê¸°ë¥¼ ë‚˜ëˆ„ì–´ ë³´ì„¸ìš”.
*(â€» ì´ ì„œë¹„ìŠ¤ëŠ” ì˜í•™ì  ì§„ë‹¨ì„ ëŒ€ì²´í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.)*
""")
st.divider()

# ==========================================
# 5. ëŒ€í™” ê¸°ë¡ ê´€ë¦¬ (Session State)
# ==========================================
if "chat_session" not in st.session_state:
    # Gemini ë¼ì´ë¸ŒëŸ¬ë¦¬ì˜ ChatSession ê°ì²´ë¥¼ ì´ˆê¸°í™”
    st.session_state.chat_session = model.start_chat(history=[])

# ==========================================
# 6. ëŒ€í™” í™”ë©´ ì¶œë ¥ ë° ì²˜ë¦¬
# ==========================================

# ê¸°ì¡´ ëŒ€í™” ë‚´ì—­ í™”ë©´ì— í‘œì‹œ
for content in st.session_state.chat_session.history:
    # roleì´ 'user'ë©´ ì‚¬ìš©ìž, 'model'ì´ë©´ AI
    with st.chat_message("user" if content.role == "user" else "ai"):
        st.markdown(content.parts[0].text)

# ì‚¬ìš©ìž ìž…ë ¥ ë°›ê¸°
if prompt := st.chat_input("ì—¬ê¸°ì— ê³ ë¯¼ì„ í„¸ì–´ë†“ìœ¼ì„¸ìš”..."):
    
    # 1) ì‚¬ìš©ìž ë©”ì‹œì§€ í™”ë©´ í‘œì‹œ
    with st.chat_message("user"):
        st.markdown(prompt)

    # 2) AIì—ê²Œ ë©”ì‹œì§€ ì „ì†¡ ë° ì‘ë‹µ ìƒì„±
    try:
        response = st.session_state.chat_session.send_message(prompt)
        
        # 3) AI ì‘ë‹µ í™”ë©´ í‘œì‹œ
        with st.chat_message("ai"):
            st.markdown(response.text)
            
    except Exception as e:
        st.error(f"ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ìž ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”. ({e})")